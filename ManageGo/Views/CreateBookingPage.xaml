<?xml version="1.0" encoding="UTF-8"?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
               xmlns:ios="clr-namespace:Xamarin.Forms.PlatformConfiguration.iOSSpecific;assembly=Xamarin.Forms.Core"
             ios:Page.UseSafeArea="true"
             xmlns:controls="clr-namespace:ManageGo.Controls"
             x:Name="ThisPage"
             xmlns:local="clr-namespace:ManageGo"
             x:Class="ManageGo.CreateBookingPage">
    <ContentPage.Resources>
        <local:UrlToImageSource x:Key="UrlToImageSource" />
        <local:StringToBoolConverter x:Key="StringToBoolConverter" />
        <local:BoolToCheckBoxIconSource x:Key="BoolToCheckBoxIconSource" />
        <local:DoubleToCurrencyString x:Key="DoubleToCurrencyString" />
        <local:EnabledStateToTextColorConverter x:Key="EnabledStateToTextColorConverter" />
        <local:TimeSpanToTimeConverter x:Key="TimeSpanToTimeConverter" />
    </ContentPage.Resources>

    <Grid RowSpacing="0">
        <Grid.RowDefinitions>
            <RowDefinition Height="auto" />
            <RowDefinition Height="auto" />
            <RowDefinition Height="auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <StackLayout Grid.Row="0"
                         BackgroundColor="White"
                         Orientation="Horizontal"
                         Padding="8"
                         HeightRequest="42">
            <Button BackgroundColor="Transparent"
                        Command="{Binding OnMasterMenuTapped}"
                        HorizontalOptions="Start"
                        WidthRequest="42"
                        IsVisible="{Binding HamburgerIsVisible}"
                        VerticalOptions="CenterAndExpand"
                        Image="nav_menu_icon.png" />
            <Image Source="logo.png"
                       Margin="0,0,0,0"
                       VerticalOptions="CenterAndExpand"
                       HorizontalOptions="CenterAndExpand" />
        </StackLayout>
        <StackLayout Spacing="0"
                         Grid.Row="1"
                         BackgroundColor="White">
            <StackLayout Orientation="Horizontal" HorizontalOptions="CenterAndExpand">
                <Label Text="Create booking"
                       TextColor="{StaticResource Grey-Dark-1}"
                       FontAttributes="Bold"
                       Margin="0,8,0,7"
                       FontSize="Medium"
                       HorizontalTextAlignment="Center" />
                <Label Text="{Binding PendingString}"
                       TextColor="{StaticResource Red}"
                       FontAttributes="Bold"
                       Margin="0,8,0,7"
                       FontSize="Medium"
                       HorizontalTextAlignment="Center" />
            </StackLayout>
            <BoxView HeightRequest="1"
                         BackgroundColor="{StaticResource Primary}" />
        </StackLayout>
        <StackLayout Grid.Row="2" Spacing="0">
            <Grid BackgroundColor="White" HeightRequest="45" Padding="4,0,4,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="1" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <StackLayout Orientation="Horizontal" Grid.Column="0" HorizontalOptions="CenterAndExpand">
                    <Image Source="building_blue.png" />
                    <Label Text="{Binding SelectedBuildingName}" LineBreakMode="TailTruncation"  MaxLines="1" HorizontalOptions="CenterAndExpand" Margin="0,2,0,0" VerticalTextAlignment="End" VerticalOptions="CenterAndExpand" FontSize="Small" TextColor="{StaticResource Grey-Mid-1}"/>

                    <StackLayout.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding OnBuildingButtonTapped}" />
                    </StackLayout.GestureRecognizers>
                </StackLayout>
                <BoxView HorizontalOptions="Center" Grid.Column="1" VerticalOptions="Fill"  BackgroundColor="{StaticResource Grey-Light-1}" Opacity=".5"/>
                <StackLayout Orientation="Horizontal" Grid.Column="2" HorizontalOptions="CenterAndExpand">
                    <Image Source="star_blue.png" VerticalOptions="CenterAndExpand" />
                    <Label Text="Edit booking"  MaxLines="1" HorizontalOptions="CenterAndExpand" Margin="0,2,0,0" VerticalTextAlignment="End" VerticalOptions="CenterAndExpand" FontSize="Small" TextColor="{StaticResource Grey-Mid-1}"/>
                </StackLayout>
            </Grid>
            <BoxView HorizontalOptions="FillAndExpand"  VerticalOptions="Start" HeightRequest="1" BackgroundColor="{StaticResource Grey-Light-1}" Opacity=".5"/>
            <!-- Building Picker Filter View -->
            <StackLayout HeightRequest="150" IsVisible="{Binding BuildingPickerIsVisible}" BackgroundColor="White" Spacing="0" Padding="22,18,22,0">
                <Label Text="Select a building:" FontSize="Small" TextColor="{StaticResource Grey-Light-1}"/>
                <controls:CustomListView HeightRequest="170" SelectionMode="None"
                                         ItemsSource="{Binding Buildings}"
                                         HasUnevenRows="true"
                                         BackgroundColor="Transparent"
                                         SeparatorVisibility="None"
                                         >
                    <x:Arguments>
                        <ListViewCachingStrategy>RecycleElement</ListViewCachingStrategy>
                    </x:Arguments>
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <ViewCell>
                                <StackLayout Orientation="Horizontal"
                                                     Padding="0,6,0,6">
                                    <Image Source="{Binding IsSelected, Converter={StaticResource BoolToCheckBoxIconSource}}" />
                                    <Label Text="{Binding BuildingDescription}"
                                                   VerticalOptions="CenterAndExpand"
                                                   LineBreakMode="TailTruncation"
                                                   FontSize="Small" />
                                    <StackLayout.GestureRecognizers>
                                        <TapGestureRecognizer NumberOfTapsRequired="1"
                                                                      Command="{Binding BindingContext.OnBuildingSelected, Source={x:Reference ThisPage}}"
                                                                      CommandParameter="{Binding .}" />
                                    </StackLayout.GestureRecognizers>
                                </StackLayout>
                            </ViewCell>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </controls:CustomListView>
                <BoxView HorizontalOptions="FillAndExpand" Margin="-22,0,-22,0"  VerticalOptions="Start" HeightRequest="1" BackgroundColor="{StaticResource Grey-Light-1}" Opacity=".5"/>

            </StackLayout>
        </StackLayout>
        <ScrollView Grid.Row="3">
            <StackLayout BackgroundColor="White"
                     Spacing="12"
                    Padding="17,9,12,9"
                         >
                <StackLayout Spacing="0">
                    <Label Text="Building:" FontSize="Small" TextColor="{StaticResource Grey-Light-1}"/>
                    <Frame HasShadow="False" Padding="0" BorderColor="{StaticResource Grey-Light-2}">
                        <controls:CustomPicker FontSize="Small" ItemsSource="{Binding Buildings}" SelectedItem="{Binding SelectedBuilding,Mode=TwoWay}" Title="Tap to select building" ItemDisplayBinding="{Binding BuildingDescription}" BackgroundColor="White" TextColor="{StaticResource Grey-Mid-1}"/>
                    </Frame>
                </StackLayout>
                <StackLayout Spacing="0">
                    <Label Text="Unit:" FontSize="Small" TextColor="{StaticResource Grey-Light-1}"/>
                    <Frame HasShadow="False" Padding="0" BorderColor="{StaticResource Grey-Light-2}">
                        <controls:CustomPicker FontSize="Small" ItemsSource="{Binding Units}" SelectedItem="{Binding SelectedUnit,Mode=TwoWay}" Title="Tap to select unit" ItemDisplayBinding="{Binding Unit}" BackgroundColor="White" TextColor="{StaticResource Grey-Mid-1}"/>
                    </Frame>
                </StackLayout>

                <StackLayout Spacing="0">

                    <controls:CustomListView ItemsSource="{Binding Tenants}" VerticalOptions="Start" HeightRequest="{Binding TenantListHeight}" SeparatorVisibility="None" SelectionMode="None" BackgroundColor="{StaticResource Off-White}">
                        <x:Arguments>
                            <ListViewCachingStrategy>RecycleElement</ListViewCachingStrategy>
                        </x:Arguments>
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <ViewCell>
                                    <StackLayout Orientation="Horizontal"
                                                     Padding="0,6,0,6">
                                        <Image Source="{Binding IsSelected, Converter={StaticResource BoolToCheckBoxIconSource}}" InputTransparent="True"/>
                                        <Label Text="{Binding FullName}"
                                           InputTransparent="True"
                                                   VerticalOptions="CenterAndExpand"
                                                   LineBreakMode="TailTruncation"
                                           TextColor="{StaticResource Primary}"
                                                   FontSize="Small" />
                                        <StackLayout.GestureRecognizers>
                                            <TapGestureRecognizer NumberOfTapsRequired="1"
                                                                      Command="{Binding BindingContext.OnTenantTapped, Source={x:Reference ThisPage}}"
                                                                      CommandParameter="{Binding .}" />
                                        </StackLayout.GestureRecognizers>
                                    </StackLayout>
                                </ViewCell>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </controls:CustomListView>
                </StackLayout>
                <StackLayout Spacing="0" IsVisible="{Binding OtherTextFieldIsVisible}">
                    <Label Text="Tenant name:" FontSize="Small" TextColor="{StaticResource Grey-Light-1}"/>
                    <local:CustomEntry Text="{Binding OtherNameText}" HasBorder="True"  BackgroundColor="White" TextColor="{StaticResource Grey-Mid-1}" FontSize="Small"/>

                </StackLayout>

                <StackLayout Spacing="0">
                    <Label Text="Amenity:" FontSize="Small" TextColor="{StaticResource Grey-Light-1}"/>
                    <Frame HasShadow="False" Padding="0" BorderColor="{StaticResource Grey-Light-2}">
                        <controls:CustomPicker FontSize="Small" ItemsSource="{Binding Amenities}" SelectedItem="{Binding SelectedAmenity,Mode=TwoWay}" Title="Select amenity" ItemDisplayBinding="{Binding Name}" BackgroundColor="White" TextColor="{StaticResource Grey-Mid-1}"/>
                    </Frame>
                </StackLayout>

                <StackLayout Spacing="0">
                    <Label Text="Date:" FontSize="Small" TextColor="{StaticResource Grey-Light-1}"/>
                    <Frame HasShadow="False" Padding="4,8,4,8" BackgroundColor="{StaticResource Off-White}"  BorderColor="{StaticResource Grey-Light-2}">
                        <Label Text="{Binding SelectedDateString}"  MaxLines="1" LineBreakMode="TailTruncation" InputTransparent="True" BackgroundColor="{StaticResource Off-White}" TextColor="{StaticResource Grey-Mid-1}" FontSize="Small"/>
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding OnSelectDateTapped}" />
                        </Frame.GestureRecognizers>
                    </Frame>
                    <controls:CalendarView SelectedDate="{Binding SelectedDate}"
                                               IsVisible="{Binding DatePickerIsVisible}"
                                               AvailableDays="{Binding ListOfAvailableDays}"
                                               ShowDisabledDates="True"
                                               CurrentMonthYearChangedCommand="{Binding HandleCalendarNavigation}"
                                               HeightRequest="250"
                                               AllowMultipleSelection="false" />
                </StackLayout>

                <Grid ColumnSpacing="100" RowSpacing="20">
                    <StackLayout Grid.Row="0" Grid.Column="0" Spacing="0">
                        <Label Text="From:" FontSize="Small" TextColor="{StaticResource Grey-Light-1}"/>
                        <Frame HasShadow="False" Padding="4,8,4,8" HeightRequest="20" BackgroundColor="White"  BorderColor="{StaticResource Grey-Light-2}">
                            <Label Text="{Binding FromTime}"  MaxLines="1" LineBreakMode="TailTruncation" InputTransparent="True" BackgroundColor="White" TextColor="{StaticResource Grey-Mid-1}" FontSize="Small"/>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding OnFromTimeLabelTapped}" />
                            </Frame.GestureRecognizers>
                        </Frame>
                        <controls:CustomListView HeightRequest="170" SelectionMode="None"
                                         ItemsSource="{Binding FromTimes}"
                                         HasUnevenRows="False"
                                         BackgroundColor="{StaticResource Off-White}"
                                                 IsVisible="{Binding FromTimeListIsVisible}"
                                         SeparatorVisibility="None"
                                         >
                            <x:Arguments>
                                <ListViewCachingStrategy>RecycleElement</ListViewCachingStrategy>
                            </x:Arguments>
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <ViewCell>
                                        <Frame Padding="4,6,0,6" CornerRadius="0" BorderColor="{StaticResource Grey-Light-2}"  BackgroundColor="{StaticResource Off-White}">
                                            <StackLayout>
                                                <Label Text="{Binding Time, Converter={StaticResource TimeSpanToTimeConverter}}"
                                                   VerticalOptions="CenterAndExpand"
                                                   LineBreakMode="TailTruncation"
                                                   TextColor="{Binding IsAvailable, Converter={StaticResource EnabledStateToTextColorConverter}}"
                                                   FontSize="Small" />
                                            </StackLayout>
                                            <Frame.GestureRecognizers>
                                                <TapGestureRecognizer NumberOfTapsRequired="1"
                                                                      Command="{Binding BindingContext.OnFromTimeSelected, Source={x:Reference ThisPage}}"
                                                                      CommandParameter="{Binding .}" />
                                            </Frame.GestureRecognizers>
                                        </Frame>
                                    </ViewCell>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </controls:CustomListView>
                    </StackLayout>
                    <StackLayout Grid.Row="0" Grid.Column="1">
                        <StackLayout Grid.Row="0" Grid.Column="0" Spacing="0">
                            <Label Text="To:" FontSize="Small" TextColor="{StaticResource Grey-Light-1}"/>
                            <Frame HasShadow="False" Padding="4,8,4,8" HeightRequest="20" BackgroundColor="White"  BorderColor="{StaticResource Grey-Light-2}">
                                <Label Text="{Binding ToTime}"  MaxLines="1" LineBreakMode="TailTruncation" InputTransparent="True" BackgroundColor="White" TextColor="{Binding EndTimeTextColor}" FontSize="Small"/>
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding OnToTimeLabelTapped}" />
                                </Frame.GestureRecognizers>
                            </Frame>
                            <controls:CustomListView HeightRequest="170" SelectionMode="None"
                                         ItemsSource="{Binding ToTimes}"
                                         HasUnevenRows="False"
                                         BackgroundColor="{StaticResource Off-White}"
                                                      IsVisible="{Binding ToTimeListIsVisible}"
                                         SeparatorVisibility="None"
                                         >
                                <x:Arguments>
                                    <ListViewCachingStrategy>RecycleElement</ListViewCachingStrategy>
                                </x:Arguments>
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <ViewCell>
                                            <Frame Padding="4,6,0,6" CornerRadius="0" BorderColor="{StaticResource Grey-Light-2}" BackgroundColor="{StaticResource Off-White}">
                                                <StackLayout>
                                                    <Label Text="{Binding Time, Converter={StaticResource TimeSpanToTimeConverter}}"
                                                   VerticalOptions="CenterAndExpand"
                                                   LineBreakMode="TailTruncation"
                                                   TextColor="{Binding IsAvailable, Converter={StaticResource EnabledStateToTextColorConverter}}"
                                                   FontSize="Small" />
                                                </StackLayout>
                                                <Frame.GestureRecognizers>
                                                    <TapGestureRecognizer NumberOfTapsRequired="1"
                                                                      Command="{Binding BindingContext.OnToTimeSelected, Source={x:Reference ThisPage}}"
                                                                      CommandParameter="{Binding .}" />
                                                </Frame.GestureRecognizers>
                                            </Frame>
                                        </ViewCell>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </controls:CustomListView>
                        </StackLayout>
                    </StackLayout>
                    <StackLayout Grid.Row="1" Grid.Column="0">
                        <Label Text="Total amount:" FontSize="Small" TextColor="{StaticResource Grey-Light-1}"/>

                        <local:CustomEntry Text="{Binding TotalAmount}" HasBorder="True" Keyboard="Numeric" BackgroundColor="White" TextColor="{StaticResource Grey-Mid-1}" FontSize="Small"/>

                    </StackLayout>
                    <StackLayout Grid.Row="1" Grid.Column="1">
                        <Label Text="Security deposit:" FontSize="Small" TextColor="{StaticResource Grey-Light-1}"/>

                        <local:CustomEntry Text="{Binding SecurityDeposit}" IsEnabled="False" HasBorder="True" Keyboard="Numeric" BackgroundColor="White" TextColor="{StaticResource Grey-Mid-1}" FontSize="Small"/>

                    </StackLayout>
                </Grid>
                <StackLayout Spacing="0">
                    <StackLayout Orientation="Horizontal" Spacing="4" Padding="0,6,0,6">
                        <Image Source="{Binding RequestPayment,Converter={StaticResource BoolToCheckBoxIconSource}}" VerticalOptions="CenterAndExpand"/>
                        <Label Text="Request payment" VerticalOptions="CenterAndExpand" FontSize="Small" TextColor="{StaticResource Primary}" />
                        <StackLayout.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding OnRequestPaymentTapped}" />
                        </StackLayout.GestureRecognizers>
                    </StackLayout>
                    <StackLayout Orientation="Horizontal" Spacing="4" Padding="0,6,0,6">
                        <Image Source="{Binding MarkAsPaid,Converter={StaticResource BoolToCheckBoxIconSource}}" VerticalOptions="CenterAndExpand"/>
                        <Label Text="Mark as paid" VerticalOptions="CenterAndExpand" FontSize="Small" TextColor="{StaticResource Primary}" />
                        <StackLayout.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding OnMarkAsPaidTapped}" />
                        </StackLayout.GestureRecognizers>
                    </StackLayout>
                    <StackLayout Orientation="Horizontal" Spacing="4" Padding="0,6,0,6">
                        <Image Source="{Binding NotApplicable,Converter={StaticResource BoolToCheckBoxIconSource}}" VerticalOptions="CenterAndExpand"/>
                        <Label Text="Not applicable" VerticalOptions="CenterAndExpand" FontSize="Small" TextColor="{StaticResource Primary}" />
                        <StackLayout.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding OnNotApplicableTapped}" />
                        </StackLayout.GestureRecognizers>
                    </StackLayout>
                </StackLayout>
                <StackLayout Spacing="0">
                    <Label Text="Note to tenant:" FontSize="Small" TextColor="{StaticResource Grey-Light-1}"/>

                    <controls:BorderlessEditor BackgroundColor="{StaticResource Off-White}" FontSize="Small" Text="{Binding NoteToTenant}" HeightRequest="80" MinimumHeightRequest="50" TextColor="{StaticResource Grey-Mid-1}"/>

                    <StackLayout Orientation="Horizontal" Spacing="0">
                        <CheckBox Color="{StaticResource Primary}" IsChecked="{Binding ApproveBooking}" VerticalOptions="CenterAndExpand"/>
                        <Label Text="Approve booking" Margin="8,0,0,0" VerticalOptions="CenterAndExpand" FontSize="Small" TextColor="{StaticResource Primary}">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding OnApproveBookingTapped}" />
                            </Label.GestureRecognizers>
                        </Label>
                    </StackLayout>
                </StackLayout>
                <Grid>
                    <Button BackgroundColor="{StaticResource Green}" Command="{Binding OnSaveBookingTapped}" FontAttributes="Bold" FontSize="Medium" TextColor="White" Text="Save" Grid.Column="0" />
                    <Button BackgroundColor="Transparent" Command="{Binding OnBackButtonTapped}" TextColor="{StaticResource Grey-Mid-1}" Text="Cancel" Grid.Column="1" />
                </Grid>
            </StackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
